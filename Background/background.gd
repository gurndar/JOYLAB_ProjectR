extends Node2D
var game_started := false
var chunks := []
var start_time = 0
var elapsed_time = 0

signal beat
signal music_start
signal spawn_obstacle

export var bpm := 120
export var chunk_scene: PackedScene
export var chunk_distance := 1280
export var chunk_spawn_y := -1280
export var chunk_despawn_y := 1920
export var scroll_speed := 400
export var scroll_per_beat := 200

var music_beat = [2.020136054421769, 2.9024943310657596, 3.3668934240362813, 3.900952380952381, 4.527891156462585, 4.992290249433107, 5.479909297052155, 5.990748299319728, 6.478367346938776, 6.989206349206349, 7.616145124716553, 8.266303854875284, 8.730702947845804, 9.241541950113378, 9.775600907029478, 10.286439909297052, 10.750839002267574, 11.284897959183674, 11.749297052154194, 12.26013605442177, 12.747755102040816, 13.165714285714285, 13.630113378684808, 14.117732426303855, 14.628571428571428, 15.139410430839002, 15.650249433106575, 16.532607709750568, 16.99700680272109, 17.484625850340137, 18.018684807256236, 18.506303854875284, 18.99392290249433, 19.481541950113378, 20.01560090702948, 20.503219954648525, 21.0140589569161, 21.501678004535147, 22.01251700680272, 22.50013605442177, 23.010975056689343, 23.49859410430839, 24.009433106575965, 24.49705215419501, 25.007891156462584, 25.495510204081633, 26.006349206349206, 26.493968253968255, 27.00480725623583, 27.492426303854874, 28.003265306122447, 28.514104308390024, 29.00172335600907, 29.489342403628118, 30.00018140589569, 30.511020408163265, 31.02185941043084, 31.48625850340136, 31.997097505668933, 32.507936507936506, 32.995555555555555, 33.41351473922902, 33.99401360544218, 34.50485260770975, 34.9924716553288, 35.48009070294785, 35.99092970521542, 36.501768707482995, 36.989387755102044, 37.50022675736962, 38.01106575963719, 38.49868480725623, 39.00952380952381, 39.497142857142855, 40.00798185941043, 40.49560090702948, 41.00643990929705, 41.4940589569161, 42.00489795918367, 42.49251700680272, 43.003356009070295, 43.490975056689344, 44.00181405895692, 44.51265306122449, 45.00027210884354, 45.48789115646259, 45.99873015873016, 46.509569160997735, 46.99718820861678, 47.484807256235825, 47.9956462585034, 48.41360544217687, 48.87800453514739, 49.36562358276644, 49.783582766439906, 50.24798185941043, 50.73560090702948, 51.24643990929705, 51.7340589569161, 52.244897959183675, 52.73251700680272, 53.2433560090703, 53.730975056689346, 54.24181405895692, 54.72943310657596, 55.263492063492066, 55.72789115646258, 56.26195011337869, 56.77278911564626, 57.2604081632653, 57.72480725623583, 58.258866213151926, 58.72326530612245, 59.25732426303855, 59.7449433106576, 60.25578231292517, 60.74340136054422, 61.25424036281179, 61.74185941043084, 62.252698412698415, 62.71709750566893, 63.25115646258504, 63.76199546485261, 64.27283446712018, 64.7372335600907, 65.15519274376418, 65.6195918367347, 66.10721088435375, 66.64126984126985, 67.10566893424036, 67.52362811791383, 67.98802721088435, 68.49886621315193, 69.0097052154195, 69.49732426303855, 70.00816326530612, 70.49578231292517, 71.00662131519275, 71.4942403628118, 72.00507936507937, 72.49269841269842, 73.02675736961451, 73.49115646258504, 73.97877551020409, 74.51283446712019, 75.00045351473923, 75.48807256235828, 75.99891156462586, 76.50975056689343, 76.99736961451246, 77.50820861678004, 77.99582766439909, 78.50666666666666, 79.01750566893423, 79.50512471655328, 79.99274376417233, 80.5035827664399, 80.99120181405895, 81.478820861678, 82.0128798185941, 82.77913832199546, 83.26675736961451, 83.77759637188208, 84.75283446712018, 85.26367346938775, 85.98349206349206, 86.77297052154195, 87.28380952380952, 87.77142857142857, 88.49124716553288, 88.90920634920634, 89.51292517006803, 90.0237641723356, 90.53460317460318, 90.97578231292518, 91.50984126984127, 92.02068027210885, 92.5082993197279, 92.99591836734695, 93.50675736961452, 94.04081632653062, 94.50521541950113, 95.0160544217687, 95.50367346938775, 96.50213151927437, 97.01297052154194, 97.500589569161, 98.03464852607709, 98.49904761904762, 99.00988662131519, 99.49750566893424, 100.00834467120181, 100.49596371882086, 101.00680272108843, 101.49442176870748, 102.00526077097506, 102.51609977324263, 103.00371882086168, 103.49133786848073, 104.0021768707483, 104.51301587301587, 105.00063492063492, 105.48825396825397, 105.99909297052154, 106.50993197278912, 107.02077097505669, 107.48517006802722, 107.99600907029479, 108.50684807256236, 108.99446712018141, 109.50530612244899, 109.99292517006803, 110.50376417233561, 111.01460317460318, 111.52544217687075, 111.98984126984126, 112.50068027210884, 112.98829931972789, 113.47591836734694, 114.00997732426303, 114.49759637188208, 115.00843537414966, 115.4960544217687, 116.00689342403628, 116.51773242630385, 117.0053514739229, 117.49297052154195, 118.00380952380952, 118.49142857142857, 119.00226757369614, 119.4898866213152, 120.00072562358277, 120.51156462585034, 120.99918367346939, 121.48680272108844, 121.99764172335601, 122.50848072562358, 122.99609977324263, 123.48371882086168, 123.99455782312926, 124.50539682539683, 125.0162358276644, 125.48063492063493, 125.9914739229025, 126.50231292517007, 126.98993197278912, 127.5007709750567, 127.98839002267573, 128.4063492063492, 128.87074829931973, 129.3815873015873, 129.98530612244897]


var music_beat_number = 0
var beat_interval := 60.0 / bpm
var beat_timer := 0.0

func _ready():

	start_countdown()
	yield(get_tree().create_timer(3.2), "timeout")
	start_time = OS.get_ticks_msec()
	_start_spawn_obstacle()

	print((music_beat[music_beat_number]))
	print(elapsed_time)
	
func start_countdown():
	yield(get_tree().create_timer(1), "timeout")
	print("3")
	yield(get_tree().create_timer(1), "timeout")
	print("2")
	yield(get_tree().create_timer(1), "timeout")
	print("1")
	yield(get_tree().create_timer(1), "timeout")
	print("Start!")
	emit_signal("music_start")
	game_started = true
	spawn_initial_chunks()
	beat_timer = 0.0

func spawn_initial_chunks():
	for i in range(3):
		var chunk = chunk_scene.instance()
		add_child(chunk)
		chunk.position = Vector2(0, chunk_spawn_y + i * chunk_distance)
		chunks.append(chunk)

func _process(delta):


	elapsed_time = (OS.get_ticks_msec() - start_time) / 1000.0
	
	if not game_started:
		return
		
	for chunk in chunks:
		chunk.position.y += scroll_speed * delta
		
	for chunk in chunks:
		if chunk.position.y > chunk_despawn_y:
			chunk.position.y = chunk_spawn_y
			
	#beat_timer += delta
	#if beat_timer >= beat_interval:
	#	beat_timer -= beat_interval
	#	_on_beat()
		
	if music_beat[music_beat_number] == elapsed_time:
		music_beat_number += 1
		emit_signal("spawn_obstacle")
		print("hi")
#	if Input.is_action_just_pressed("pressedSpaceBar"):
#		_check_input_timing()
		
func _on_beat():
	emit_signal("beat")

func _check_input_timing():
	var timing_error = abs(beat_timer - beat_interval / 2)

	if timing_error <= 0.075:
		print("Perfect!")
	elif timing_error <= 0.15:
		print("Good!")
	elif timing_error <= 0.25:
		print("Bad!")
	else:
		print("Miss!")

func _start_spawn_obstacle():
#	while not music_beat_number >= 222:
#		if music_beat[music_beat_number] == elapsed_time:
#			print("hi")
#			music_beat_number += 1
	pass


func _on_background_music_start():
	pass # Replace with function body.
